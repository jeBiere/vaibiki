# Спека: GUI для настройки, улучшение аудиопроцессора, поддержка Hyprland

Дата: 2026-01-30
Автор: (auto)

## 1. Цели
1) Сделать полноценный GUI для настройки всех параметров без ручного редактирования `config.yaml`.
2) Добавить живое превью результата (визуализация, часы, оверлей) прямо в GUI.
3) Существенно улучшить аудио‑процессор: качество, стабильность, управляемость параметрами; исследовать интеграцию/режим с glava.
4) Реализовать полноценную поддержку Hyprland/Wayland (не только X11).

## 2. Текущий контекст (по коду)
- Точка входа: `main.py` (PyQt5, полноэкранный виджет, аргумент `--overlay`).
- Основная логика: `app.py`, `audio_processor.py`, `overlay_manager.py`.
- UI‑компоненты: `components/visualization.py`, `components/clock.py`, `components/overlay.py`.
- Конфиг: `config.yaml` + загрузка/сохранение `config.py`.
- Ограничение: сейчас принудительно `QT_QPA_PLATFORM = xcb` (X11‑only).

## 3. Объем работ (Scope)
### 3.1 GUI для настройки (Configurator)
Функции:
- Редактирование всех параметров `config.yaml` через GUI.
- Превью: отрисовка визуализатора + часов + оверлея без перехода в полноэкранный режим.
- Позиционирование:
  - Перетаскивание и изменение размера визуализатора мышью.
  - Отдельные контролы x/y/width/height, shift_y.
  - Привязки/снап к краям/центру экрана (опционально).
- Цвета:
  - Пикеры цвета для градиента (`gradient_start`, `gradient_end`), часов.
  - Поддержка HEX и alpha (opacity).
- Шрифты:
  - Выбор семейства, размера (ratio), веса, межстрочного интервала.
- Оверлей:
  - Вкл/выкл.
  - Выбор изображения (file picker) с копированием в `assets/`.
  - Предпросмотр и масштаб (fit/fill/expand).
- Аудио параметры:
  - Ползунки/вводы для `bar_count`, `samplerate`, `blocksize`, `buffer_blocks`, `exp_smooth_factor`, `max_change_speed`, `noise_floor`, `peak_sharpness`, `avg_window_size`, `visualization_mode`, `fmin`, `fmax`, `cqt_bins_per_bar`, `bins_per_octave`, `accent_threshold`, `accent_boost`.
- Профили:
  - Сохранение/загрузка наборов параметров (preset) в отдельные файлы `presets/*.yaml`.

Структура GUI:
- Левый сайдбар: дерево настроек (Visualizer, Clock, Overlay, Audio, Window/System, Presets).
- Центральная панель: превью с интерактивным позиционированием.
- Правая панель: свойства выбранного блока.

Технически:
- Создать отдельный модуль/приложение "Configurator" (например, `configurator.py`) или режим запуска `--configurator`.
- Использовать те же `components/*` для рендера превью (внутри обычного окна).
- GUI на PyQt5 (без смены фреймворка).

### 3.2 Улучшение аудиопроцессора
Базовые задачи:
- Изучить текущий `AudioProcessor` и оценить проблемы: задержка, резкость, шумы, стабильность.
- Пересмотреть pipeline: буферизация, нормализация, CQT/FFT параметры, сглаживание.
- Улучшить качество реактивности, сделать управление параметрами предсказуемым.

Направления улучшения:
- Вариант A (внутреннее улучшение):
  - Перейти на более стабильный FFT (например, `numpy.fft` или `scipy.signal.stft`).
  - Нормализация по rolling RMS/peak.
  - Улучшение логики акцентов.
  - Более прозрачное управление частотами (linear/log/mel).
- Вариант B (интеграция glava):
  - Исследовать архитектуру glava: источник аудио, пайплайн, граф.
  - Сделать отдельный режим "GLAVA" в конфиге.
  - Вариант интеграции:
    1) Поднять glava как отдельный процесс и читать его данные (IPC).
    2) Интегрировать glava‑style pipeline в Python (если есть открытая спецификация формата).

Результат этапа:
- Конкретное решение: либо улучшенный внутренний движок, либо отдельный режим с glava.
- Документировать параметры и схемы.

### 3.3 Поддержка Hyprland/Wayland
Цель: полноценная поддержка Wayland/Hyprland без принудительного X11.

Требования:
- Убрать жесткую установку `QT_QPA_PLATFORM = xcb`.
- Реализовать режим "desktop overlay" для Wayland:
  - Поведение в Hyprland, аналогичное X11 (находится "под окнами", не мешает фокусу).
- Исследовать доступные способы:
  - Layer‑shell (`zwlr_layer_shell_v1`) для Wayland.
  - Использование `qtwayland` и подходящих флагов окна.
  - Возможность fallback на XWayland при отсутствии layer‑shell.

Ожидаемый UX:
- На Hyprland визуализатор можно запустить в режиме "desktop" (фон), и он корректно рендерится.
- При необходимости — режим "overlay" (поверх окон).

## 4. Предлагаемые изменения в структуре проекта
- Добавить:
  - `configurator.py` или `modes/configurator.py`.
  - `components/preview_canvas.py` (контейнер для превью и интерактивного позиционирования).
  - `audio/` (новая папка с улучшенным пайплайном и альтернативными реализациями).
  - `platform/wayland.py`, `platform/x11.py` — управление платформенными особенностями.
- Обновить `config.yaml` (новые параметры и presets).
- Обновить `README.md` (описание GUI и режимов).

## 5. Новый UI/UX: требования и детали
### 5.1 Превью
- Превью должно учитывать текущий конфиг.
- При изменении параметров обновление происходит в реальном времени.
- Превью не полноэкранное, а в окне GUI (масштабируется по размеру).
- Возможность включить "live audio" или "fake signal" для теста (генератор).

### 5.2 Позиционирование
- Drag‑resize рамки визуализатора.
- Drag‑move по экрану.
- Визуальные направляющие и отображение координат.
- Быстрые кнопки: центр, нижний край, верхний край, растянуть по ширине.

### 5.3 Цвета
- Пикер + ввод HEX.
- Превью градиента.
- Опционально: сохранение палитр.

### 5.4 Шрифты
- Выбор семейства (dropdown с доступными системными шрифтами).
- Размер (ratio) и weight.
- Превью текста часов прямо в панели.

### 5.5 Оверлей
- File picker с автокопированием в `assets/`.
- Переключатель "enabled".
- Режим масштабирования: fit/fill/stretch.
- Позиция/offset, если нужно (опционально).

## 6. Поддержка Hyprland — критерии
- Приложение корректно стартует в Wayland (без forced xcb).
- Есть флаг `--backend wayland|x11` (или автоматический выбор).
- На Hyprland визуализатор можно закрепить в layer‑shell (desktop/overlay layer).
- Если Wayland недоступен — fallback на X11.

## 7. Спецификация конфигурации (черновик)
```
visualizer:
  x: 822
  y: 170
  width: 1788
  height: 344
  shift_y: 50
  gradient_start: '#DE726E'
  gradient_end: '#F0B781'

clock:
  enabled: true
  color: '#FFFFFF'
  opacity: 220
  font_family: Helvetica
  font_size_ratio: 0.2
  font_weight: bold
  line_spacing: 1.0
  vertical_offset: 10
  format:
    hours: hh
    minutes: mm

overlay:
  enabled: true
  image: assets/new.png
  scale_mode: fill   # fit|fill|stretch

audio:
  bar_count: 100
  samplerate: 44100
  blocksize: 1024
  buffer_blocks: 32
  exp_smooth_factor: 0.3
  max_change_speed: 0.6
  noise_floor: 0.02
  peak_sharpness: 2
  avg_window_size: 5
  visualization_mode: bass_center
  fmin: 100.0
  fmax: 6000.0
  cqt_bins_per_bar: 3
  bins_per_octave: 12
  accent_threshold: 5
  accent_boost: 5
  backend: internal   # internal|glava

platform:
  backend: auto       # auto|x11|wayland
  wayland_layer: background  # background|bottom|top|overlay
```

## 8. План внедрения (итерации)
1) Базовый GUI
   - Создать окно, подключить чтение/сохранение `config.yaml`.
   - Отобразить превью текущего состояния.
   - Добавить основные контролы: позиции, цвета, шрифты, оверлей.

2) Интерктивное позиционирование
   - Drag/resize + отображение координат.
   - Снап к границам.

3) Аудио‑процессор v2
   - Исследование (benchmark, сравнение).
   - Прототип улучшенного pipeline.

4) Режим glava (если выбран)
   - Исследование интеграции.
   - Реализация режима и переключатель в GUI.

5) Hyprland
   - Реализовать layer‑shell/Wayland режим.
   - Fallback X11.
   - Документация.

## 9. Acceptance Criteria
GUI:
- Все параметры `config.yaml` редактируются через GUI.
- Превью отображается корректно и обновляется в реальном времени.
- Можно вручную выбрать оверлей, цвета, шрифты.

Audio:
- Улучшена стабильность, меньше шумов.
- Новая реализация документирована и тестирована.

Hyprland:
- Запуск и корректное позиционирование на Wayland/Hyprland.
- Есть fallback на X11.

## 10. Риски и вопросы
- Интеграция glava может оказаться сложной без готового Python API.
- Layer‑shell для Wayland требует внешних библиотек/оберток.
- Баланс между качеством и производительностью аудиопроцессора.

## 11. Зафиксированные решения (ответы на вопросы)
- GUI запускается отдельным процессом (отдельное окно/исполняемый режим, не встраивается в визуализатор).
- Нужен hot reload без перезапуска визуализатора (изменения в GUI сразу применяются).
- glava должна быть встроена в приложение (используем логику обработки аудио glava, визуализация остаётся текущей; учёт оверлея обязателен).
- Одновременный запуск internal и glava невозможен (строго один backend за раз).

## 12. Следующие шаги (решить до реализации)
- Выбор стратегии интеграции glava (перенос логики или частичная адаптация пайплайна).
- Способ hot‑reload (IPC: сокеты, файлы, shared memory, или Qt IPC).
- Подход к Wayland layer‑shell (библиотека или самописный binding).
